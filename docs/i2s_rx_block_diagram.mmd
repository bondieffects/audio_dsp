flowchart TB
    %% I2S RX (Receiver) Block Diagram

    RST["reset_n<br/>Active Low Reset"]

    subgraph inputs ["External Inputs"]
        BCLK["i2s_bclk<br/>Bit Clock"]
        WS["i2s_ws<br/>Word Select<br/>0=Left, 1=Right"]
        SDATA["i2s_sdata<br/>Serial Audio Data"]
    end
    
    subgraph outputs ["Audio Outputs"]
        LEFT["audio_left<br/>16-bit Left Sample"]
        RIGHT["audio_right<br/>16-bit Right Sample"] 
        READY["rx_ready<br/>Sample Ready Flag"]
    end
    
    subgraph state_machine ["RX State Machine"]
        IDLE_STATE["IDLE State<br/>Wait for WS=0"]
        LEFT_STATE["LEFT_CHANNEL State<br/>sync_ready flag<br/>Receive 16-bit left sample"]
        RIGHT_STATE["RIGHT_CHANNEL State<br/>sync_ready flag<br/>Receive 16-bit right sample"]
    end
    
    subgraph shared_resources ["Shared Processing Resources"]
        SYNC["sync_ready<br/>Skip first clock after WS change<br/>"]
        SHIFTREG["rx_shift_register<br/>16-bit Serial to Parallel"]
    end
    
    subgraph storage ["Sample Storage & Output"]
        LEFT_SAMPLE["left_sample<br/>16-bit Register"]
        RIGHT_SAMPLE["right_sample<br/>16-bit Register"]
        VALID_FLAG["valid_output<br/>Pulse when both samples ready"]
    end

    %% Input connections
    RST --> state_machine
    RST --> shared_resources
    RST --> storage
    BCLK --> state_machine
    BCLK --> shared_resources
    WS --> state_machine
    SDATA --> shared_resources
    
    %% State transitions (direct flow)
    IDLE_STATE --> LEFT_STATE
    LEFT_STATE --> RIGHT_STATE
    RIGHT_STATE --> LEFT_STATE
    
    %% Control flow
    state_machine --> shared_resources
    shared_resources --> storage
    
    %% Data flow annotations
    shared_resources -.->|"After 16 bits<br/>Left channel"| LEFT_SAMPLE
    shared_resources -.->|"After 16 bits<br/>Right channel<br/>Set valid_output=1"| RIGHT_SAMPLE
    
    %% Output connections
    LEFT_SAMPLE --> LEFT
    RIGHT_SAMPLE --> RIGHT
    VALID_FLAG --> READY

    %% Styling
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef outputStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef stateStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef sharedStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef storageStyle fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000

    class BCLK,WS,RST,SDATA inputStyle
    class LEFT,RIGHT,READY outputStyle
    class IDLE_STATE,LEFT_STATE,RIGHT_STATE stateStyle
    class SHIFTREG,BITCOUNTER,SYNC sharedStyle
    class LEFT_SAMPLE,RIGHT_SAMPLE,VALID_FLAG storageStyle