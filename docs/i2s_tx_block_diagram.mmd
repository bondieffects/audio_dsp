flowchart TB
    %% I2S TX (Transmitter) Block Diagram

    RST["reset_n<br/>Active Low Reset"]

    subgraph inputs ["External Inputs"]
        BCLK["i2s_bclk<br/>Bit Clock"]
        WS["i2s_ws<br/>Word Select<br/>0=Left, 1=Right"]
        LEFT_IN["audio_left<br/>16-bit Left Sample"]
        RIGHT_IN["audio_right<br/>16-bit Right Sample"]
        TX_READY["tx_ready<br/>New Data Valid"]
    end
    
    subgraph outputs ["I2S Outputs"]
        SAMPLE_REQ["sample_request<br/>Request Next Sample"]
        SDATA_OUT["i2s_sdata<br/>Serial Audio Data"]
    end
    
    subgraph state_machine ["TX State Machine"]
        IDLE_STATE["IDLE State<br/>Wait for WS transition"]
        LEFT_STATE["LEFT_CHANNEL State<br/>Transmit 16-bit left sample"]
        RIGHT_STATE["RIGHT_CHANNEL State<br/>Transmit 16-bit right sample"]
    end
    
    subgraph shared_resources ["Serial Transmission Logic"]
        SAMPLE_GEN["request_sample<br/>Generate when WS=0 and state=IDLE"]
        SHIFTREG["tx_shift_register<br/>16-bit Serial Shift Register"]
    end
    
    subgraph storage ["Sample Storage & Control"]
        LEFT_LATCH["left_data_latched<br/>16-bit Register"]
        RIGHT_LATCH["right_data_latched<br/>16-bit Register"]
    end

    %% Input connections
    RST --> state_machine
    RST --> shared_resources
    RST --> storage
    BCLK --> state_machine
    BCLK --> shared_resources
    WS --> state_machine
    LEFT_IN --> storage
    RIGHT_IN --> storage
    TX_READY --> storage
    
    %% State transitions
    IDLE_STATE --> LEFT_STATE
    LEFT_STATE --> RIGHT_STATE
    RIGHT_STATE --> LEFT_STATE
    
    %% Control flow
    state_machine --> shared_resources
    storage --> shared_resources
    
    %% Output connections
    SAMPLE_GEN --> SAMPLE_REQ
    SHIFTREG --> SDATA_OUT

    %% Styling
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px, color:#000
    classDef outputStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px, color:#000
    classDef stateStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px, color:#000
    classDef sharedStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px, color:#000
    classDef storageStyle fill:#ffebee,stroke:#c62828,stroke-width:2px, color:#000

    class BCLK,WS,RST,LEFT_IN,RIGHT_IN,TX_READY inputStyle
    class SDATA_OUT,SAMPLE_REQ outputStyle
    class IDLE_STATE,LEFT_STATE,RIGHT_STATE stateStyle
    class SHIFTREG,BITCOUNTER,SAMPLE_GEN sharedStyle
    class LEFT_LATCH,RIGHT_LATCH storageStyle